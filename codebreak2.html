<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Medical Terminology Master</title>

  <!-- PWA support -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#07C160">

  <style>
    :root {
      --primary: #07C160;
      --secondary: #FFC300;
      --accent: #0080FF;
      --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text: #ffffff;
      --correct: #07C160;
      --wrong: #FA5151;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-user-select: none;
      user-select: none;
    }

    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-gradient);
      color: var(--text);
      overflow: hidden;
      touch-action: manipulation;
    }

    .header {
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(10px);
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 1000;
    }

    .game-container {
      padding-top: 70px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      max-width: 800px;
      margin: 0 auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 10px;
      transition: width 0.5s ease;
      width: 0;
    }

    .streak-counter {
      position: fixed;
      top: 80px;
      right: 20px;
      background: rgba(255,195,0,0.2);
      border: 2px solid var(--secondary);
      border-radius: 15px;
      padding: 8px 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 100;
      font-weight: bold;
    }

    .term {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary);
      padding: 15px 25px;
      background: rgba(7,193,96,0.1);
      border-radius: 20px;
      border: 2px solid var(--primary);
      transition: all 0.3s;
      text-align: center;
      max-width: 90%;
      touch-action: none;
    }

    .term.expanded {
      transform: scale(1.15);
      box-shadow: 0 0 30px rgba(7,193,96,0.3);
    }

    .scissor-tool {
      position: fixed;
      width: 60px;
      height: 60px;
      background: var(--secondary);
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      box-shadow: 0 4px 20px rgba(255,195,0,0.5);
      z-index: 1000;
      transition: transform 0.2s;
      touch-action: none;
    }

    .piece, .meaning-card {
      background: rgba(255,255,255,0.15);
      border-radius: 15px;
      padding: 12px 20px;
      font-size: 1.2rem;
      border: 2px solid transparent;
      transition: all 0.3s;
      touch-action: none;
      user-select: none;
    }

    .piece.dragging, .meaning-card.dragging {
      opacity: 0.7;
      position: fixed;
      z-index: 9999;
      pointer-events: none;
    }

    .dropzone {
      background: rgba(255,255,255,0.08);
      border-radius: 15px;
      padding: 20px 10px;
      min-height: 100px;
      border: 2px dashed rgba(255,255,255,0.3);
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .dropzone.active { border-color: var(--primary); background: rgba(7,193,96,0.1); }

    .dropzone.correct { border-color: var(--correct); background: rgba(7,193,96,0.2); }

    .meaning-card.matched {
      background: rgba(7,193,96,0.3);
      border: 2px solid var(--correct);
    }

    .game-button {
      background: linear-gradient(45deg, var(--primary), var(--accent));
      border: none;
      color: white;
      font-size: 1.1rem;
      padding: 14px 32px;
      border-radius: 50px;
      margin: 16px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0,212,255,0.4);
      font-weight: bold;
    }

    .hidden { display: none !important; }

    @media (max-width: 768px) {
      .term { font-size: 1.7rem; padding: 12px 20px; }
      .piece, .meaning-card { padding: 10px 15px; font-size: 1rem; }
    }
  </style>
</head>
<body>

<div class="header">
  <div class="user-info" style="display:flex; align-items:center; gap:10px;">
    <div class="avatar" style="width:40px;height:40px;border-radius:50%;background:linear-gradient(45deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:1.2rem;">MD</div>
    <div>
      <div style="font-weight:bold;">Term Master</div>
      <div style="font-size:0.8rem;opacity:0.8;">Level 3</div>
    </div>
  </div>
  <div class="coins" style="background:rgba(255,195,0,0.2);border:1px solid var(--secondary);border-radius:20px;padding:4px 12px;display:flex;align-items:center;gap:6px;font-weight:bold;">
    <span>‚≠ê</span><span id="coinCount">150</span>
  </div>
</div>

<div class="streak-counter">
  <span class="streak-flame">üî•</span>
  <span id="streakCount">7 Streak</span>
</div>

<div class="game-container">
  <div class="progress-section" style="padding:15px 20px;">
    <div class="progress-container" style="width:100%;background:rgba(255,255,255,0.1);border-radius:10px;height:10px;overflow:hidden;margin-bottom:10px;">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div style="text-align:center;font-size:0.9rem;opacity:0.8;">
      Question <span id="currentQuestion">1</span> of <span id="totalQuestions">10</span>
    </div>
  </div>

  <div class="question-area" id="questionArea"></div>
</div>

<div class="scissor-tool" id="scissorTool">‚úÇÔ∏è</div>

<div class="achievement-popup hidden" id="achievementPopup" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#667eea,#764ba2);border-radius:20px;padding:25px;z-index:10000;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.5);width:85%;max-width:400px;">
  <div class="achievement-icon" style="font-size:3.5rem;margin-bottom:15px;animation:bounce 1s infinite alternate;">üèÜ</div>
  <h3>Achievement Unlocked!</h3>
  <p id="achievementText">5 Correct Answers in a Row</p>
  <p style="color:var(--secondary);margin-top:10px;font-weight:bold;">+50 Coins</p>
</div>

<script>
const gameData = {
  questions: [
    {
      id: 1,
      sentence: "The patient was <span class='term'>hypoglycaemic</span>",
      term: "hypoglycaemic",
      breakdown: ["hypo", "glyc", "aem", "ic"],
      meanings: ["low", "sugar", "blood", "pertaining to"],
      correctOrder: ["prefix", "root", "root", "suffix"],
      explanation: "low blood sugar"
    },
    {
      id: 2,
      sentence: "There was swelling in the <span class='term'>interphalangeal</span> joints",
      term: "interphalangeal",
      breakdown: ["inter", "phalange", "al"],
      meanings: ["between", "finger or toe bones", "pertaining to"],
      correctOrder: ["prefix", "root", "suffix"],
      explanation: "pertaining to between the finger or toe bones"
    },
    // ... add more
  ],
  state: {
    score: 0,
    coins: 150,
    streak: 0,
    currentQuestionIndex: 0,
    totalQuestions: 3,
    achievements: [],
    userData: JSON.parse(localStorage.getItem('medTermMaster')) || { coins: 150, totalCorrect: 0 }
  },
  draggedElement: null,
  dragType: null, // "piece" or "meaning"
  touchOffset: { x: 0, y: 0 }
};

function initGame() {
  loadUserData();
  updateUI();
  loadQuestion(0);
  setupGlobalDragListeners();
}

function loadUserData() {
  if (gameData.state.userData) {
    gameData.state.coins = gameData.state.userData.coins || 150;
  }
}

function saveUserData() {
  gameData.state.userData.coins = gameData.state.coins;
  gameData.state.userData.totalCorrect = gameData.state.score;
  localStorage.setItem('medTermMaster', JSON.stringify(gameData.state.userData));
}

function updateUI() {
  document.getElementById('coinCount').textContent = gameData.state.coins;
  document.getElementById('streakCount').textContent = `${gameData.state.streak} Streak`;
  document.getElementById('currentQuestion').textContent = gameData.state.currentQuestionIndex + 1;
  document.getElementById('totalQuestions').textContent = gameData.state.totalQuestions;

  const progress = (gameData.state.currentQuestionIndex / gameData.state.totalQuestions) * 100;
  document.getElementById('progressBar').style.width = `${progress}%`;
}

function loadQuestion(index) {
  if (index >= gameData.questions.length) return endGame();

  const q = gameData.questions[index];
  const area = document.getElementById('questionArea');

  area.innerHTML = `
    <div class="sentence" style="font-size:1.2rem;text-align:center;margin:20px;padding:0 10px;line-height:1.5;">${q.sentence}</div>

    <div class="term-display" style="position:relative;margin:20px 0 40px;width:100%;display:flex;justify-content:center;">
      <div class="term" id="mainTerm">${q.term}</div>
      <div class="tap-hint" style="position:absolute;bottom:-25px;left:50%;transform:translateX(-50%);font-size:0.8rem;color:rgba(255,255,255,0.6);">Tap to expand ‚ñº</div>
    </div>

    <div class="pieces-container" id="piecesContainer" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:30px 0;min-height:70px;padding:10px;"></div>

    <div class="drop-zones" id="dropZones" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin:20px 10px;width:100%;">
      <div class="dropzone" data-type="prefix"><div style="font-size:2rem;">üî∞</div><div class="zone-label">Prefix</div></div>
      <div class="dropzone" data-type="root"><div style="font-size:2rem;">üéØ</div><div class="zone-label">Root Word</div></div>
      <div class="dropzone" data-type="suffix"><div style="font-size:2rem;">üè∑Ô∏è</div><div class="zone-label">Suffix</div></div>
    </div>

    <div class="meanings-container" id="meaningsContainer" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin:20px 0;padding:10px;width:100%;">
      <h3 style="grid-column:1/-1;text-align:center;margin-bottom:15px;">Match the Meanings</h3>
    </div>

    <button class="game-button hidden" id="nextButton">Next Question</button>
  `;

  document.getElementById('nextButton').onclick = nextQuestion;

  setupTermInteraction(q);
  updateUI();
}

function setupTermInteraction(question) {
  const term = document.getElementById('mainTerm');

  term.addEventListener('click', () => {
    term.classList.toggle('expanded');
    term.classList.contains('expanded') ? showScissorTool() : hideScissorTool();
  });

  // Long press hint (optional)
  let timer;
  term.addEventListener('touchstart', e => {
    timer = setTimeout(() => alert(`Hint: ${question.term} has ${question.breakdown.length} parts`), 700);
  }, {passive: true});
  term.addEventListener('touchend', () => clearTimeout(timer));
}

function showScissorTool() {
  const sc = document.getElementById('scissorTool');
  sc.style.display = 'flex';
  sc.style.left = 'calc(50% - 30px)';
  sc.style.top = '250px';
  setupDrag(sc, null, onScissorMove, onScissorEnd);
}

function hideScissorTool() {
  document.getElementById('scissorTool').style.display = 'none';
}

function setupDrag(el, type, onMove, onEnd) {
  function start(e) {
    e.preventDefault();
    const touch = e.touches ? e.touches[0] : e;
    gameData.touchOffset.x = touch.clientX - el.getBoundingClientRect().left;
    gameData.touchOffset.y = touch.clientY - el.getBoundingClientRect().top;
    gameData.draggedElement = el;
    gameData.dragType = type;
    el.classList.add('dragging');
    document.addEventListener('mousemove', move);
    document.addEventListener('touchmove', move, {passive: false});
    document.addEventListener('mouseup', end);
    document.addEventListener('touchend', end);
  }

  function move(e) {
    if (!gameData.draggedElement) return;
    e.preventDefault();
    const touch = e.touches ? e.touches[0] : e;
    el.style.left = (touch.clientX - gameData.touchOffset.x) + 'px';
    el.style.top  = (touch.clientY - gameData.touchOffset.y) + 'px';
    onMove?.(touch.clientX, touch.clientY);
  }

  function end(e) {
    if (!gameData.draggedElement) return;
    e.preventDefault();
    const touch = e.changedTouches ? e.changedTouches[0] : e;
    onEnd?.(touch.clientX, touch.clientY);
    el.classList.remove('dragging');
    el.style.left = ''; el.style.top = '';
    gameData.draggedElement = null;
    gameData.dragType = null;
    document.removeEventListener('mousemove', move);
    document.removeEventListener('touchmove', move);
    document.removeEventListener('mouseup', end);
    document.removeEventListener('touchend', end);
  }

  el.addEventListener('mousedown', start);
  el.addEventListener('touchstart', start, {passive: false});
}

function onScissorMove(x, y) {
  // You can add visual cut line preview here if desired
}

function onScissorEnd(x, y) {
  const termEl = document.getElementById('mainTerm');
  const rect = termEl.getBoundingClientRect();
  if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
    const cutPos = x - rect.left;
    handleCut(cutPos, rect.width);
  }
  hideScissorTool();
}

function handleCut(cutPosition, termWidth) {
  const q = gameData.questions[gameData.state.currentQuestionIndex];
  const ratio = cutPosition / termWidth;

  let bestIdx = 0, minDiff = 1;
  let len = 0;
  for (let i = 0; i < q.breakdown.length - 1; i++) {
    len += q.breakdown[i].length;
    const pos = len / q.term.length;
    const diff = Math.abs(pos - ratio);
    if (diff < minDiff) { minDiff = diff; bestIdx = i; }
  }

  if (minDiff < 0.18) {
    splitTerm(q);
    gameData.state.streak++;
    showFeedback(true);
  } else {
    gameData.state.streak = 0;
    showFeedback(false);
  }
}

function splitTerm(question) {
  const cont = document.getElementById('piecesContainer');
  cont.innerHTML = '';

  question.breakdown.forEach((part, i) => {
    const p = document.createElement('div');
    p.className = 'piece';
    p.textContent = part;
    p.dataset.type = question.correctOrder[i];
    cont.appendChild(p);
    setupDrag(p, 'piece', null, (x,y) => handlePieceDrop(x,y,p));
  });

  setupMeanings(question);
  document.getElementById('mainTerm').classList.remove('expanded');
}

function handlePieceDrop(x, y, piece) {
  let dropped = false;
  document.querySelectorAll('.dropzone').forEach(zone => {
    const r = zone.getBoundingClientRect();
    if (x > r.left && x < r.right && y > r.top && y < r.bottom) {
      if (piece.dataset.type === zone.dataset.type) {
        zone.appendChild(piece);
        piece.classList.add('correct');
        piece.style.position = 'static';
        checkAllPiecesCorrect();
        gameData.state.coins += 10;
        showFeedback(true);
      } else {
        showFeedback(false);
        gameData.state.streak = 0;
      }
      dropped = true;
    }
  });
  if (!dropped) {
    document.getElementById('piecesContainer').appendChild(piece);
  }
  updateUI();
}

function checkAllPiecesCorrect() {
  const correct = document.querySelectorAll('.piece.correct').length;
  if (correct === gameData.questions[gameData.state.currentQuestionIndex].breakdown.length) {
    gameData.state.score++;
    // You can trigger achievement check here
  }
}

function setupMeanings(question) {
  const cont = document.getElementById('meaningsContainer');
  const shuffled = [...question.meanings].sort(()=>Math.random()-0.5);

  shuffled.forEach(m => {
    const c = document.createElement('div');
    c.className = 'meaning-card';
    c.textContent = m;
    cont.appendChild(c);
    setupDrag(c, 'meaning', null, (x,y) => {
      // For simplicity ‚Äî just mark matched on drop anywhere (improve later)
      c.classList.add('matched');
      gameData.state.coins += 5;
      showFeedback(true);
      updateUI();
    });
  });
}

function showFeedback(correct) {
  const emoji = correct ? '‚úÖ' : '‚ùå';
  const div = document.createElement('div');
  div.style.cssText = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:5rem;opacity:0;z-index:1000;pointer-events:none;`;
  div.textContent = emoji;
  document.body.appendChild(div);
  setTimeout(() => { div.style.transition = 'opacity 0.6s'; div.style.opacity = '1'; }, 10);
  setTimeout(() => { div.style.opacity = '0'; setTimeout(()=>div.remove(),600); }, 800);

  if (navigator.vibrate) navigator.vibrate(correct ? 80 : 180);
}

function nextQuestion() {
  gameData.state.currentQuestionIndex++;
  loadQuestion(gameData.state.currentQuestionIndex);
}

function endGame() {
  const area = document.getElementById('questionArea');
  area.innerHTML = `
    <div style="text-align:center;padding:60px 20px;">
      <h2>Session Complete! üéâ</h2>
      <div style="background:rgba(255,255,255,0.1);border-radius:20px;padding:25px;margin:25px 0;">
        <p style="font-size:1.3rem;margin:12px 0;">Score: ${gameData.state.score}/${gameData.state.totalQuestions}</p>
        <p style="font-size:1.3rem;margin:12px 0;">Coins: ${gameData.state.coins}</p>
      </div>
      <button class="game-button" onclick="location.reload()">Play Again</button>
    </div>
  `;
  saveUserData();
}

function setupGlobalDragListeners() {
  // Global touchmove prevention when dragging
  document.addEventListener('touchmove', e => {
    if (gameData.draggedElement) e.preventDefault();
  }, {passive: false});
}

window.addEventListener('DOMContentLoaded', initGame);
</script>
</body>
</html>
